# IM软件中的资源存储优化


对于一个IM软件而言，文件的收发与存储是非常基础的一个功能，随着多媒体技术的更新迭代，媒体文件的发送、接收、存储也越来越便捷和频繁。参考竞品的文件收发存储流程，我发现我们App在这方面存在一些不足，这些不足，在一个IM软件起步阶段，产品和测试是比较难发现的，也是目前微信相对于一些国外IM软件，至今都被诟病的一点，那就是资源文件占据了太大的磁盘空间。

想要提升一个文件自身的上传/下载速度及降低其占用空间，无非就是保持质量的前提下尽可能提高压缩率，在这点YallaChat目前和竞品已经几乎没有差距。 和竞品的差距主要体现在相同文件重复分发时的处理机制上，这里举个例子：

我们发送一个系统相册里的视频给某个好友次，目前YallaChat的做法是：
* 发送方 将原视频压缩。
* 发送方 将压缩后视频存储到本地路径，然后将视频上传到文件服务器，换取视频下载路径。
* 发送方 生成视频消息，每条消息附带视频对应的下载路径，将视频消息发送给接收方。
* 接收方 收到视频消息，开始视频。
* 接收方 下载视频，将视频存储到本地缓存路径。

这个流程看似没有问题，但是如果我继续发送同样的视频给任意好友，上面的流程依然会重复。换言之，同一个视频，即使我发送给同一个人100次，发送方的手机上就会存100份，上传就是100次，文件服务器就会存100份，接收方就会存100份。很显然这是一种空间和时间上的双重浪费。

造成这个现象的根本原因，是在于我们目前的消息和文件是一一对应的，而每一条消息又是唯一的，所以每一条消息的文件也是唯一的，不会去关心文件是否相同。


而竞品的流程大致是这样的(细节可能需要补充)：
* 发送方 将原视频压缩，获取到视频文件的哈希值，通过哈希值生成唯一缓存路径，判断这个路径下是否已经有相同视频。若没有，将这个视频存储到本地。
* 发送方 上传视频之前，先告知服务端上传视频的哈希值，根据服务端返回的内容，判断是否要上传视频到文件服务器。
* 服务端 根据发送方上报的哈希，判断是否已有该视频，若存在，直接返回下载路径，若不存在，接收发送方上传的视频，并根据该哈希值生成下载路径。(这里简化了服务端的逻辑，实际上服务端和文件服务器之间还有通信)
* 发送方 获取到视频下载路径，生成视频消息，相同的视频对应一个唯一下载路径，将视频消息发送给接收方。
* 接收方 收到视频消息，先检查本地是否已经有视频资源，没有，则开始下载对应视频，存储到对应路径。如果本地已有，则不再重复下载。
* 接收方 下载完视频，根据视频哈希值生成缓存路径。 


可以直观的发现，这种方式对应同一个视频资源，发送方、接收方、服务端都只存储了一份文件，且上传和下载，也都只有一次。


通过对比可以发现，两种处理机制，最核心的不同是在于文件的唯一性的判断标准不同。前者是根据文件消息的唯一性来确定的，一条消息对应一个文件。后者是根据文件本身的唯一性来确定的。

实际上两种方案各有利弊，第二个方案虽然节省了流量和存储空间，但有一定的门槛，比如需要自己设计文件存储服务器，一些三方的文件存储服务器并不支持，且整个流程相对于第一种方案也复杂不少。此外，因为三端都只维护了一份视频，容易出现删一个视频，多条消息找不到视频的情况。

但从综合角度来看，在文件分享越来越普及、app越做越臃肿的当下，能够节省用户流量和手机空间，也是一个IM软件需要考虑的因素之一。

目前YallaChat在上传/下载测可能无法实现省流的目的，但是在两端的存储空间方面，理论上是有提升余地的。


